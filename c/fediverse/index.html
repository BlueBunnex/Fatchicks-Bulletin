<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Fediverse (Mastodon?) App</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Outfit:wght@100..900&display=swap');

        :root { --accent: #d64; }
        
        body { width: 45em; margin: auto; font-family: "Outfit", sans-serif; }

        a { color: var(--accent); }
        
        button { border: 0; color: grey; background: none; font: inherit; padding: 0.5em; cursor: pointer; }
        button:disabled { padding-bottom: calc(0.5em - 2px); color: var(--accent); border-bottom: 2px solid var(--accent); font-weight: 700; }

        input { padding: 0.5em; border: 0; border-left: 1px solid lightgrey; }
    </style>
    <script type="module">

        // Tutorial: https://docs.joinmastodon.org/client/intro/

        const contentInsert            = document.getElementById("content-insert");
        
        const buttonLoadStatusesPublic = document.getElementById("button-load-statuses-public");
        const inputLoadFromSearch      = document.getElementById("input-load-from-search");
        
        buttonLoadStatusesPublic.onclick = loadStatusesPublic;
        inputLoadFromSearch.onchange     = loadFromSearch;

        async function fetchAndInsertStatuses(URL) {

            const response = await fetch(URL,
                {
                    method: "GET",
                    headers: {
                        "content-type": "application/json"
                    }
                }
            );
    
            if (response.status != 200) {
                alert("Error " + response.status);
                return;
            }

            const statuses = await response.json();

            console.log(statuses);

            for (const status of statuses) {
    
                let imageEmbed = "";

                for (const media of status.media_attachments) {

                    if (media.type === "image")
                        imageEmbed += `<img height="200" src="${ media.url }">`;
                }

                contentInsert.innerHTML += `
                    <div style="margin: 1em 0; padding: 1em; border: 1px solid black; border-radius: 8px;">
                        <strong><a href="${ status.account.url }">${ status.account.username }</a></strong>
                        <br>
                        ${ status.content }
                        <br>
                        ${ imageEmbed }
                    </div>
                `;
            }
        }

        async function loadFromSearch() {

            // reset context
            buttonLoadStatusesPublic.disabled = false;

            contentInsert.innerHTML = "";

            // decode what they're trying to search (user or hashtag)
            
            // hashtag search
            fetchAndInsertStatuses(`https://mastodon.social/api/v1/timelines/tag/${ inputLoadFromSearch.value }?limit=40`);

            // user search (idk how I should do this actually)
            // https://mastodon.social/api/v1/accounts/lookup?acct=johnnnnn
            // https://mastodon.social/api/v1/accounts/113480132212449271/statuses
        }
        
        async function loadStatusesPublic() {

            // reset context
            buttonLoadStatusesPublic.disabled = true;
            inputLoadFromSearch.value = "";

            contentInsert.innerHTML = "";

            // fetch
            fetchAndInsertStatuses("https://mastodon.social/api/v1/timelines/public?limit=40");
        }

        loadStatusesPublic();
    </script>
</head>
<body>

    <div style="display: flex; gap: 1em; border-bottom: 1px solid lightgrey;">
        <button id="button-load-statuses-public">Global</button>
        <button id="button-load-statuses-followers">Followers</button>
        <input style="flex: 1;" id="input-load-from-search" type="text" placeholder="Search @users or #hashtags">
    </div>

    <div id="content-insert"></div>
    
</body>
</html>
