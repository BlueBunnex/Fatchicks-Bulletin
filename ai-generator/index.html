<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>AI horde ui (wip :3)</title>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,100;0,300;0,400;0,500;0,700;0,900;1,100;1,300;1,400;1,500;1,700;1,900&display=swap');
        
        body { font-family: "Roboto", sans-serif; background: #181216; color: #bbb; display: grid; grid-template-columns: 3fr 2fr; gap: 1em; align-items: start; min-height: 100vh; line-height: 1.2em; }

        a { color: #c63; }

        input, textarea { background: none; border: 1px solid #ccc; color: inherit; }

        #generateButton { cursor: pointer; background: none; border: 2px solid #c63; font: inherit; color: #c63; padding: 0.5em; }

        #gallery { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 4px; }
        #gallery > img { width: 100%; }

        #prompt { max-width: 100%; min-width: 100%; min-height: 2em; box-sizing: border-box; }

        #debug { border: 1px solid #444; background: black; font-size: smaller; font-family: monospace; word-wrap: break-word; min-height: 1em; }

        #allGenerations { display: flex; flex-direction: column-reverse; gap: 1em; }
        #allGenerations > div { border: 1px solid #ccc; padding: 0.5em; }
        
        #mainImage { width: 100%; }

        #widthSlider, #heightSlider { width: 100%; }
    </style>
    
    <script type="module">

        function setCookie(cname, cvalue, exdays) {
            const d = new Date();
            d.setTime(d.getTime() + (exdays*24*60*60*1000));
            let expires = "expires="+ d.toUTCString();
            document.cookie = cname + "=" + cvalue + ";" + expires + ";path=/";
        }

        function getCookie(cname) {
            let name = cname + "=";
            let decodedCookie = decodeURIComponent(document.cookie);
            let ca = decodedCookie.split(';');
            for(let i = 0; i <ca.length; i++) {
                let c = ca[i];
                while (c.charAt(0) == ' ') {
                c = c.substring(1);
                }
                if (c.indexOf(name) == 0) {
                return c.substring(name.length, c.length);
                }
            }
            return "";
        }

        const debug            = document.getElementById("debug");
        const key              = document.getElementById("key");
        const prompt           = document.getElementById("prompt");
        const mainImage        = document.getElementById("mainImage");
        const gallery          = document.getElementById("gallery");
        const generateButton   = document.getElementById("generateButton");
        const modelSelector    = document.getElementById("modelSelector");
        const widthSlider      = document.getElementById("widthSlider");
        const heightSlider     = document.getElementById("heightSlider");
        const allGenerations   = document.getElementById("allGenerations");

        generateButton.onclick = startGeneration;

        key.value = getCookie("apikey");
        if (key.value.trim().length === 0) {
            key.value = "0000000000";
        }
        
        async function startGeneration() {

            debug.innerHTML = "";
            
            try {
        
                const payload = {
                    prompt: prompt.value,
                    nsfw  : true,
                    models: (modelSelector.value == "any" ? [] : [ modelSelector.value ]),
                    params: {
                        //seed: "dogs",
                        width : Math.min(Math.max( widthSlider.value -  (widthSlider.value % 64), 512), 1024),
                        height: Math.min(Math.max(heightSlider.value - (heightSlider.value % 64), 512), 1024)
                    }
                };

                const startTime = Date.now();

                const response = await fetch("https://stablehorde.net/api/v2/generate/async",
                    {
                        method: "POST",
                        headers: {
                            "content-type": "application/json",
                            "apikey"      : key.value
                        },
                        body: JSON.stringify(payload)
                    }
                );

                const responseJson = await response.json();
                const currentID = responseJson.id;
                
                debug.innerHTML = response;

                const generationElement = document.createElement("div");
                allGenerations.appendChild(generationElement);

                if (response.status == 202) {

                    // save key to cookie
                    setCookie("apikey", key.value, 50);

                    // wait for generation
                    const generation = await retrieveGeneration();
                    const timeElapsed = ((Date.now() - startTime) / 1000).toFixed(1);

                    mainImage.src = generation.img;
                    gallery.innerHTML = `<img src="${ generation.img }">${ gallery.innerHTML }`;

                    generationElement.innerHTML = `Finished generating in ${ timeElapsed }s.`;

                } else {
                    throw Error(JSON.stringify(responseJson));
                }
        
            } catch (error) {
                generationElement.innerHTML = "Generation failed.";
                debug.innerHTML = "<span style='color: red;'>" + error + "</span>";
            }
        }

        async function retrieveGeneration() {

            var finished = false;

            while (!finished) {

                await new Promise(r => setTimeout(r, 5000));

                // check
                const response = await (await fetch("https://stablehorde.net/api/v2/generate/check/" + currentID, { method: "GET" })).json();

                debug.innerHTML = JSON.stringify(response);

                generationStatus.innerHTML = `Waiting on generation (position in queue: ${ response.queue_position })`;

                finished = response.finished == 1;
            }

            // status
            const response = await (await fetch("https://stablehorde.net/api/v2/generate/status/" + currentID, { method: "GET" })).json();

            debug.innerHTML = JSON.stringify(response);

            return response.generations[0];
        }

        async function loadModels() {
        
            // models
            let response = await (await fetch("https://stablehorde.net/api/v2/status/models?" + new URLSearchParams({ min_count: 5 }).toString(),
                {
                    method: "GET",
                    headers: {
                        "content-type": "application/json"
                    }
                }
            )).json();
    
            modelSelector.innerHTML = "<option value='any'>Any Model</option>";
            
            for (const model of response) {
                
                console.log(model);
                modelSelector.innerHTML += `<option value="${ model.name }">${ model.name } (${ model.count })</option>`;
            }
        }

        loadModels();

    </script>

    <script>
        function updateReadout(inputId, readoutId) {

            document.getElementById(readoutId).innerHTML = document.getElementById(inputId).value;
        }
    </script>
</head>
<body>
    
    <div>

        <textarea id="prompt" rows="4" placeholder="Prompt..."></textarea>

        <br><br>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1em; align-items: start;">

            <table>
                <tr>
                    <td><a href="https://stablehorde.net/">AI Horde</a> API<br>Key (optional):</td>
                    <td><input type="text" id="key"></td>
                </tr>
                <tr>
                    <td>Model:</td>
                    <td><select id="modelSelector"></select></td>
                </tr>
                <tr>
                    <td>Width:</td>
                    <td style="display: flex;">
                        <span id="widthReadout">640</span>
                        <input type="range" id="widthSlider" min="512" max="1024" step="64" value="640" oninput="updateReadout('widthSlider', 'widthReadout')">
                    </td>
                </tr>
                <tr>
                    <td>Height:</td>
                    <td style="display: flex;">
                        <span id="heightReadout">832</span>
                        <input type="range" id="heightSlider" min="512" max="1024" step="64" value="832" oninput="updateReadout('heightSlider', 'heightReadout')">
                    </td>
                </tr>
            </table>

            <div style="overflow: hidden;">
                <button type="button" id="generateButton">Generate</button>
                <br><br>
                <div id="debug"></div>
                <br><br>
                <div id="allGenerations"></div>
            </div>
            
        </div>

        <br><br><br><br><br>

        c.cu, betterwithsalt, spellsx.<br>
        "slightly" can decrease a term<br>
        small breasts, big breasts, huge breasts, gigantic breasts<br><br>
        <small>Powered by the <a href="https://stablehorde.net/api/">AI Horde API</a></small>

    </div>

    <div>

        <img id="mainImage">

        <div id="gallery"></div>

    </div>

</body>
</html>
